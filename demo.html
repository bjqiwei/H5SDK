<html>
<head>
    <meta charset="utf-8"/>
    <title>live demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Styles -->
    <link href="./assets/css/bootstrap.css" rel="stylesheet"/>
    <style type="text/css">
        body {
            padding-top: 80px;
            padding-bottom: 40px;
        }

        .navbar-inner-red {
            background-color: #600000;
            background-image: none;
            background-repeat: no-repeat;
            filter: none;
        }

        .full-screen {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .normal-screen {
            position: relative;
        }

        .call-options {
            padding: 5px;
            background-color: #f0f0f0;
            border: 1px solid #eee;
            border: 1px solid rgba(0, 0, 0, 0.08);
            -webkit-border-radius: 4px;
            -moz-border-radius: 4px;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
            -webkit-transition-property: opacity;
            -moz-transition-property: opacity;
            -o-transition-property: opacity;
            -webkit-transition-duration: 2s;
            -moz-transition-duration: 2s;
            -o-transition-duration: 2s;
        }

        .label-align {
            display: block;
            padding-left: 15px;
            text-indent: -15px;
        }

        .input-align {
            width: 13px;
            height: 13px;
            padding: 0;
            margin: 0;
            vertical-align: bottom;
            position: relative;
            top: -1px;
            *overflow: hidden;
        }

        .glass-panel {
            z-index: 99;
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            top: 0;
            left: 0;
            opacity: 0.8;
            background-color: Gray;
        }

        .div-keypad {
            z-index: 100;
            position: fixed;
            -moz-transition-property: width;
            -o-transition-property: width;
            -webkit-transition-duration: 2s;
            -moz-transition-duration: 2s;
            -o-transition-duration: 2s;
        }

    </style>
    <link href="./assets/css/bootstrap-responsive.css" rel="stylesheet"/>
    <script type="text/javascript" src="WebPhone.js"></script>
    <!-- Javascript code -->
    <script type="text/javascript">
        var oNotifICall;
        var oReadyStateTimer;

        window.onload = function () {
            window.console && window.console.info && window.console.info("location=" + window.location);
            loadCredentials();
            // Initialize call button
            btnRegister.disabled = false;

            uiBtnCallSetText("Call");
            oReadyStateTimer = setInterval(function () {
                        if (document.readyState === "complete") {
                            clearInterval(oReadyStateTimer);
							WebPhone.setLogLevel(txtLogLevel.value);
                            WebPhone.Init();
                        }
                    },
                    500);

        }
		
		window.onunload  = function (){
			WebPhone.ClearCall();
		}

        //加载保存信息
        function loadCredentials() {
            if (window.localStorage) {
                // IE retuns 'null' if not defined
                var s_value;
                if ((s_value = window.localStorage.getItem('org.yuntongxun.identity.display_name'))) txtDisplayName.value = s_value;
                if ((s_value = window.localStorage.getItem('org.yuntongxun.identity.impi'))) txtPrivateIdentity.value = s_value;
                if ((s_value = window.localStorage.getItem('org.yuntongxun.identity.impu'))) txtPublicIdentity.value = s_value;
                if ((s_value = window.localStorage.getItem('org.yuntongxun.identity.password'))) txtPassword.value = s_value;
                if ((s_value = window.localStorage.getItem('org.yuntongxun.identity.realm'))) txtRealm.value = s_value;
            }
            else {
            }
        }
        //信息保存
        function saveCredentials() {
            if (window.localStorage) {
                window.localStorage.setItem('org.yuntongxun.identity.display_name', txtDisplayName.value);
                window.localStorage.setItem('org.yuntongxun.identity.impi', txtPrivateIdentity.value);
                window.localStorage.setItem('org.yuntongxun.identity.impu', txtPublicIdentity.value);
                window.localStorage.setItem('org.yuntongxun.identity.password', txtPassword.value);
                window.localStorage.setItem('org.yuntongxun.identity.realm', txtRealm.value);
            }
        }
        //ui
        function showNotifICall(s_number) {
            // permission already asked when we registered
            if (window.webkitNotifications && window.webkitNotifications.checkPermission() == 0) {
                if (oNotifICall) {
                    oNotifICall.cancel();
                }
                oNotifICall = window.webkitNotifications.createNotification('images/sipml-34x39.png', 'Incaming call', 'Incoming call from ' + s_number);
                oNotifICall.onclose = function () {
                    oNotifICall = null;
                };
                oNotifICall.show();
            }
        }

        //ui
        function uiOnConnectionEvent(b_connected, b_connecting) { // should be enum: connecting, connected, terminating, terminated
            btnRegister.disabled = b_connected || b_connecting;
            btnUnRegister.disabled = !b_connected && !b_connecting;
            btnCall.disabled = !(b_connected);
            btnHangUp.disabled = true;
        }
        //ui
        function uiBtnCallSetText(s_text) {
            switch (s_text) {
                case "Call":
                {
                    var bDisableCallBtnOptions = false;
                    btnCall.value = btnCall.innerHTML = bDisableCallBtnOptions ? 'Call' : 'Call <span id="spanCaret" class="caret">';
                    btnCall.setAttribute("class", bDisableCallBtnOptions ? "btn btn-primary" : "btn btn-primary dropdown-toggle");
                    btnCall.onclick = bDisableCallBtnOptions ? function () {
                        WebPhone.MakeCall();
                    } : null;
                    ulCallOptions.style.visibility = bDisableCallBtnOptions ? "hidden" : "visible";
                    if (!bDisableCallBtnOptions && ulCallOptions.parentNode != divBtnCallGroup) {
                        divBtnCallGroup.appendChild(ulCallOptions);
                    }
                    else if (bDisableCallBtnOptions && ulCallOptions.parentNode == divBtnCallGroup) {
                        document.body.appendChild(ulCallOptions);
                    }

                    break;
                }
                default:
                {
                    btnCall.value = btnCall.innerHTML = s_text;
                    btnCall.setAttribute("class", "btn btn-primary");
                    btnCall.onclick = function () {
                        WebPhone.AnswerCall();
                    };
                    ulCallOptions.style.visibility = "hidden";
                    if (ulCallOptions.parentNode == divBtnCallGroup) {
                        document.body.appendChild(ulCallOptions);
                    }
                    break;
                }
            }
        }
        //ui
        function uiCallTerminated(s_description) {
            uiBtnCallSetText("Call");
            btnHangUp.value = 'HangUp';
            btnHoldRetrieve.value = 'Hold';
			btnHoldRetrieve.onclick = function(){
				WebPhone.HoldCall();
			}
            btnCall.disabled = false;
            btnHangUp.disabled = true;
			document.getElementById("ringbacktone").pause();
			document.getElementById("ringtone").pause();
			

            txtCallStatus.innerHTML = "<i>" + s_description + "</i>";
            divCallOptions.style.opacity = 0;

            if (oNotifICall) {
                oNotifICall.cancel();
                oNotifICall = null;
            }


            setTimeout(function () {
               txtCallStatus.innerHTML = '';
            }, 2500);
        }

		WebPhone.onMakeCallFailed = function(e){
			uiCallTerminated(e.reason + ":" + e.msg);
		}
		
        WebPhone.onReceived = function (e) {
            uiBtnCallSetText('Answer');
            btnHangUp.value = 'HangUp';
            btnCall.disabled = false;
            btnHangUp.disabled = false;
            document.getElementById("ringtone").play();
            var sRemoteNumber = (e.caller || 'unknown');
            showNotifICall(sRemoteNumber);
        }


        WebPhone.onCallCleared = function (e) {
            divGlassPanel.style.visibility = 'hidden';
            uiCallTerminated(e.msg);
        }

        WebPhone.onConnected = function () {
            uiOnConnectionEvent(true, false);
            txtRegStatus.innerHTML = "<i>" + "已登录" + "</i>";
        }

		WebPhone.onConnectError = function (e) {
            uiOnConnectionEvent(false, false);
            txtRegStatus.innerHTML = "<i>" + e.msg + "</i>";
        }

        WebPhone.onLogout = function () {
            uiOnConnectionEvent(false, false);
            txtRegStatus.innerHTML = "<i>" + "已退出" + "</i>";
        }



        WebPhone.onHeld = function (e) {
            btnHoldRetrieve.value = 'Retrieve';
            btnHoldRetrieve.disabled = false;
			btnHoldRetrieve.onclick = function () {
				WebPhone.RetrieveCall();
			};
            txtCallStatus.innerHTML = '<i>通话保持</i>';
        }

		WebPhone.onOriginated = function(e){
			txtCallStatus.innerHTML = '<i>外呼中</i>';
		}
		
		WebPhone.onDelivered = function(e){
			txtCallStatus.innerHTML = '<i>对方振铃</i>';
		}
		
		WebPhone.onEstablished = function(e)
		{
			txtCallStatus.innerHTML = '<i>通话中</i>';
			btnCall.disabled = true;
            btnHangUp.disabled = false;
			document.getElementById("ringbacktone").pause();
			document.getElementById("ringtone").pause();
			divCallOptions.style.opacity = 1;
		}
		
        WebPhone.onHeldFailed = function (e) {
            btnHoldRetrieve.value = 'Hold';
			btnHoldRetrieve.onclick = function(){
				WebPhone.HoldCall();
			}
            btnHoldRetrieve.disabled = false;
            txtCallStatus.innerHTML = '<i>通话保持失败</i>';
        }

        WebPhone.onRetrieved = function (e) {
 
            btnHoldRetrieve.value = 'Hold';
            btnHoldRetrieve.disabled = false;
			btnHoldRetrieve.onclick = function(){
				WebPhone.HoldCall();
			}
            txtCallStatus.innerHTML = '<i>通话恢复</i>';
            
        }

        WebPhone.onRetrieveFailed = function (e) {
            btnHoldRetrieve.disabled = false;
		    btnHoldRetrieve.onclick = function(){
				WebPhone.RetrieveCall();
			}
            txtCallStatus.innerHTML = '<i>恢复通话失败</i>';
        }


        WebPhone.onTransferred = function (e) {
            txtCallStatus.innerHTML = '<i>呼叫转接结束</i>';
            btnTransfer.disabled = false;
        }

        WebPhone.onTransferFailed = function (e) {
            txtCallStatus.innerHTML = '<i>Call transfer failed</i>';
            btnTransfer.disabled = false;
        }



        function sipRegister() {
            WebPhone.Login(txtRealm.value, txtPrivateIdentity.value, txtPublicIdentity.value, txtPassword.value, txtDisplayName.value, txtWebsocketUrl.value, txtICEServer.value);
			uiOnConnectionEvent(false,true);
        }
        function sipCallAudio() {
            WebPhone.MakeCall(txtPhoneNumber.value);
        }

        function TransferCall() {
            WebPhone.TransferCall(null, txtPhoneNumber.value);
        }
    </script>
</head>
<body>
<div class="container">
    <div class="row-fluid">
        <div class="span4 well">
            <label style="width: 100%;" align="center" id="txtRegStatus"> </label>

            <h2>
                注册
            </h2>
            <br/>
            <table style='width: 100%'>
                <tr>
                    <td>
                        <label style="height: 100%">
                            用户名:
                        </label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtDisplayName" value="1008"
                               placeholder="1000"/>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label style="height: 100%">
                            SIP ID:
                        </label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtPrivateIdentity" value="1008"
                               placeholder="1000"/>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label style="height: 100%">
                            SIP URI:
                        </label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtPublicIdentity" value="sip:1008@192.168.177.178:38890"
                               placeholder="sip:1000@222.36.4.254:8880"/>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label style="height: 100%">密码:</label>
                    </td>
                    <td>
                        <input type="password" style="width: 100%; height: 100%" id="txtPassword" value="123456"/>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label style="height: 100%">域名:</label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtRealm" value="192.168.177.178:38890" placeholder="222.36.4.254:8880"/>
                    </td>
                </tr>

                <tr>
                    <td>
                        <label style="height: 100%">Websocket URL:</label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtWebsocketUrl" value="wss://192.168.177.179:7731" placeholder="wss://222.36.4.254:4443"/>
                    </td>
                </tr>

                <tr>
                    <td>
                        <label style="height: 100%">ICE Servers:</label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtICEServer" value="[{ url:'turn:192.168.177.179:3478', username: 'test',credential:'12#Test123'}]"/>
                    </td>
                </tr>
				<tr>
                    <td>
                        <label style="height: 100%">Log Level:</label>
                    </td>
                    <td>
                        <input type="text" style="width: 100%; height: 100%" id="txtLogLevel" value="debug"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" align="right">
                        <input type="button" class="btn btn-success" id="btnRegister" value="登陆" disabled onclick='sipRegister();'/>
                        &nbsp;
                        <input type="button" class="btn btn-danger" id="btnUnRegister" value="注销" disabled onclick='WebPhone.Logout();'/>
                    </td>
                </tr>
            </table>
        </div>
        <div id="divCallCtrl" class="span7 well" style='display:table-cell; vertical-align:middle'>
            <label style="width: 100%;" align="center" id="txtCallStatus">
            </label>

            <h2>
                呼叫控制
            </h2>
            <br/>
            <table style='width: 100%;'>
                <tr>
                    <td style="white-space:nowrap;">
                        <input type="text" style="width: 100%; height:100%;" id="txtPhoneNumber" value="1234" placeholder="输入呼叫SIP URI"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="1" align="right">
                        <div class="btn-toolbar" style="margin: 0; vertical-align:middle">
                            <div id="divBtnCallGroup" class="btn-group">
                                <button id="btnCall" disabled class="btn btn-primary" data-toggle="dropdown">Call</button>
                            </div>
                            &nbsp;&nbsp;
                            <div class="btn-group">
                                <input type="button" id="btnHangUp" style="margin: 0; vertical-align:middle; height: 100%;" class="btn btn-primary" value="HangUp" onclick='WebPhone.ClearCall();'
                                       disabled/>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td align='center'>
                        <div id='divCallOptions' class='call-options' style='opacity: 0; margin-top: 0px'>
                            <input type="button" class="btn" style="" id="btnHoldRetrieve" value="Hold" onclick='WebPhone.HoldCall();'/> &nbsp;
                            <input type="button" class="btn" style="" id="btnTransfer" value="Transfer" onclick='TransferCall();'/> &nbsp;
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <br/>
    <footer>

        <!-- Creates all ATL/COM objects right now
            Will open confirmation dialogs if not already done
        -->
        <object id="fakePluginInstance" classid="clsid:69E4A9D1-824C-40DA-9680-C7424A27B6A0" style="visibility:hidden;"></object>

        <!--
            NPAPI  browsers: Safari, Opera and Firefox
        -->
        <!--embed id="WebRtc4npapi" type="application/w4a" width='1' height='1' style='visibility:hidden;' /-->
    </footer>
</div>
<!-- /container -->
<!-- Glass Panel -->
<div id='divGlassPanel' class='glass-panel' style='visibility:hidden'></div>

<!-- Call button options -->
<ul id="ulCallOptions" class="dropdown-menu" style="visibility:hidden">
    <li><a href="#" onclick='sipCallAudio("call-audio");'>Audio</a></li>
    <li class="divider"></li>
</ul>

<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script type="text/javascript" src="./assets/js/jquery.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-transition.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-alert.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-modal.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-dropdown.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-scrollspy.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-tab.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-tooltip.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-popover.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-button.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-collapse.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-carousel.js"></script>
<script type="text/javascript" src="./assets/js/bootstrap-typeahead.js"></script>

<!-- Audios -->
<audio id="ringtone" loop="true" src="sounds/ringtone.wav"></audio>
<audio id="ringbacktone" loop="true" src="sounds/ringbacktone.wav"></audio>
<audio id="dtmfTone" src="sounds/dtmf.wav"></audio>

<!-- GOOGLE ANALYTICS -->
<script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-6868621-19");
        pageTracker._trackPageview();
    } catch (err) {
    }
</script>

</body>
</html>
